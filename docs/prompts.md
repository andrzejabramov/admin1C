## 📄 `docs/PROMPT.md`

```markdown
# Контекст проекта для ИИ-ассистента

## 🎯 Цель

Разработка консольного оркестратора администрирования 1С с вертикальной доменной архитектурой под управлением ОС Ubuntu. Каждый сервис — автономная подсистема с полной изоляцией: `backup`, `rm`, `storage`, `lic`.

## 📚 Справочная система (архитектурный компонент)

Документация реализована на двух уровнях для покрытия всех сценариев использования:

| Уровень                      | Носитель          | Ответственность                              | Пример доступа                      |
| ---------------------------- | ----------------- | -------------------------------------------- | ----------------------------------- |
| **Консольная справка**       | `orchestrator.py` | Быстрый синтаксис команд, флаги, примеры     | `ib1c help`<br>`ib1c backup --help` |
| **Расширенная документация** | `docs/*.md`       | Архитектура, сценарии, примеры с пояснениями | `/opt/1cv8/scripts/docs/README.md`  |

### Требования к консольной справке

| Команда                    | Поведение                                     | Реализация                                       |
| -------------------------- | --------------------------------------------- | ------------------------------------------------ |
| `ib1c` (без аргументов)    | Показать список подкоманд с кратким описанием | `argparse` с обработкой отсутствия аргумента     |
| `ib1c help`                | Показать список подкоманд с кратким описанием | Подкоманда `help` в `orchestrator.py`            |
| `ib1c <subcommand> --help` | Детальная справка по подкоманде               | Стандартный `argparse.ArgumentParser` в адаптере |

> 💡 **Принцип:** Консольная справка должна быть самодостаточной для выполнения базовых операций без обращения к `.md` файлам.

## 📦 Вертикальная доменная структура (целевая)
```

/opt/1cv8/scripts/
├── orchestrator.py # Единая точка входа (ib1c)
├── .gitignore
├── .version # Версия системы
├── ib_list.conf # Статический список ИБ для массовых операций
├── requirements.txt
│
├── img/
├── docs/
│ ├── prompts.md
│ └── README.md
│
├── engines/
│ ├── utils.sh
│ └── config/
│ └── global.sh # Общие настройки: PG_HOST, PG_PORT, BACKUP_ROOT, SSH_KEY
│
├── core/ # Общие утилиты (без бизнес-логики)
│ ├── engine.py # run_engine() — универсальный запуск скриптов
│ ├── utils.py # Цвета терминала, логирование
│ └── exceptions.py # Кастомные исключения
│
├── backup/ # 📦 Домен: бэкапы
│ ├── engines/
│ │ └── backup.sh # pg_dump через SSH
│ ├── services/
│ │ ├── \_init**.py # Пустой маркер модуля
│ │ └── backup_service.py # backup_ib(), backup_multiple()
│ └── adapters/
│ ├── cli/
│ ├── **init**.py # Пустой маркер модуля
│ └── backup_adapter.py # CLI-адаптер (argparse → сервис → вывод)
│
├── rm/ # 🗑️ Домен: удаление
│ ├── engines/
│ │ └── rm.sh # Удаление файлов бэкапов
│ ├── services/
│ │ ├── **init**.py
│ │ └── rm_service.py # rm_ib(), rm_multiple()
│ └── adapters/
│ ├── cli/
│ └── rm_adapter.py # CLI-адаптер
│ ├── **init**.py
│
├── storage/ # 💾 Домен: мониторинг + управление списком ИБ
│ ├── engines/
│ │ ├── disk_usage.sh # Статистика диска (df)
│ │ ├── list_backups.sh # Список бэкапов (TSV)
│ │ ├── count_backups.sh # Подсчёт количества/размера бэкапов
│ │ ├── validate.sh # Валидация состояния хранилища
│ │ ├── list_ibs.sh # Получение списка ИБ из кластера 1С (rac)
│ │ └── ssl.sh # Управление SSL-сертификатами
│ ├── services/
│ │ ├── **init**.py
│ │ └── storage_service.py # get_usage(), get_ib_stats(), update_ib_list()
│ └── adapters/
│ ├── cli/
│ ├── **init**.py
│ └── storage_adapter.py # CLI-адаптер (storage, list-ibs, update-ib-list)
│
└── lic/ # 🪪 Домен: мониторинг и управление лицензиями 1С
│ ├── engines/
│ │ ├── license_list.sh # Список лицензий в табличном виде
│ │ ├── license_detail.sh # Чтение бинарных данных лицензии
│ │ ├── license_info.sh # Информация о состоянии лицензий
│ │ ├── monitor.sh # Мониторинг доступности лицензий
│ │ └── backup.sh # Создание архивных копий файлов лицензий
│ ├── services/
│ │ ├── **init**.p
│ │ └── lic_service.py # get_license_list(), backup_licenses()
│ ├── adapters/cli/
│ │ │── cli/
│ │ ├── **init\_\_.py
│ │ └── lic_adapter.py # CLI-адаптер (lic list/backup/monitor)
│ └── config/
└── lic.sh # Пути к файлам лицензий 1С

````

## 🔑 Ключевые принципы

| Принцип | Реализация |
|---------|------------|
| **Изоляция доменов** | `backup/`, `rm/`, `storage/`, `lic/` не зависят друг от друга; все домены используют только `core/` |
| **Статический список ИБ** | `backup/` и `rm/` читают только `ib_list.conf` (НЕ вызывают `storage/`) |
| **Управление списком ИБ** | `storage/` предоставляет утилиту `update-ib-list` для обновления `ib_list.conf` |
| **Защита от удаления ИБ** | Удаление ИБ из `ib_list.conf` требует `--confirm` (предотвращение потери истории бэкапов) |
| **Чистая бизнес-логика** | `services/*_service.py` не знает про интерфейсы (CLI/Web/Telegram) |
| **Тонкие адаптеры** | `adapters/cli/*_adapter.py` содержит только парсинг аргументов, справку (`--help`) и вывод |
| **Единая точка вызова** | Все движки запускаются через `core.engine.run_engine()` |
| **Конфиденциальность** | В публичной документации используются ТОЛЬКО тестовые ИБ: `test_db`, `db_test` |
| **Самодостаточная справка** | `ib1c help` и `ib1c <subcommand> --help` покрывают 90% сценариев без `.md` |

## ⚠️ Запрещено

- Дублировать код из `core/` в домены
- Хранить чувствительные данные в сервисных конфигах
- Добавлять бизнес-логику в `core/`
- Создавать кросс-зависимости между доменами
- Автоматически удалять ИБ из `ib_list.conf` без `--confirm`
- Использовать реальные имена ИБ в публичной документации (только `test_db`, `db_test`)
- Оставлять подкоманды без реализации `--help`

## 🧪 Тестирование изменений в `core/`

Любое изменение в `core/` требует проверки ВСЕХ доменов:
```bash
ib1c help
ib1c backup --ib test_db --format dump --dry-run
ib1c rm --ib test_db --timestamp 20260206_124957 --dry-run
ib1c storage
ib1c storage list-ibs
ib1c storage update-ib-list --dry-run
ib1c lic list
ib1c lic backup --dry-run
````

## 📥 Формат предоставления кода для анализа

````
[Файл] /путь/к/файлу.py

```python
код здесь
````

```

ИЛИ для структуры:

```

[Структура] /путь/к/папке/

папка/
├── подпапка/
└── файл.py

---[Файл] /путь/к/файлу.py---

```python
код
```

```

## 🚧 Текущий статус разработки

| Домен | Статус | Примечание |
|-------|--------|------------|
| `backup` | ✅ Рабочий | Вертикальная структура реализована |
| `rm` | ✅ Рабочий | Вертикальная структура реализована |
| `storage` | ✅ Рабочий | Вертикальная структура реализована + управление ИБ/SSL |
| `lic` | ✅ Рабочий | Вертикальная структура реализована (новый сервис) |
| `core/` | ✅ Стабилен | Контракт `run_engine()` зафиксирован |
| `orchestrator.py` | ✅ Рабочий | Поддержка `ib1c help` и всех подкоманд |
```

---
