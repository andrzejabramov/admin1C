## 📄 `docs/README.md`

# ib1c — консольный оркестратор администрирования 1С

Утилита командной строки для ускорения и упрощения управления сервером 1С и кластером информационных баз под управлением ОС Ubuntu. Текущий функционал реализован в 4 сервисах: `storage` (мониторинг хранилища бэкапов), `backup` (создание резервных копий), `rm` (удаление бэкапов), `lic` (мониторинг и управление лицензиями 1С).

## 🌳 Структура проекта

```
/opt/1cv8/scripts/
├── orchestrator.py # Единая точка входа (ib1c)
├── .gitignore
├── .version # Версия системы
├── ib_list.conf # Статический список ИБ для массовых операций
├── requirements.txt
│
├── img/
├── docs/
│ ├── prompts.md
│ └── README.md
│
├── engines/
│ ├── utils.sh
│ └── config/
│ └── global.sh # Общие настройки: PG_HOST, PG_PORT, BACKUP_ROOT, SSH_KEY
│
├── core/ # Общие утилиты (без бизнес-логики)
│ ├── engine.py # run_engine() — универсальный запуск скриптов
│ ├── utils.py # Цвета терминала, логирование
│ └── exceptions.py # Кастомные исключения
│
├── backup/ # 📦 Домен: бэкапы
│ ├── engines/
│ │ └── backup.sh # pg_dump через SSH
│ ├── services/
│ │ ├── _init__.py # Пустой маркер модуля
│ │ └── backup_service.py # backup_ib(), backup_multiple()
│ └── adapters/
│   ├── cli/
│     ├── __init__.py # Пустой маркер модуля
│     └── backup_adapter.py # CLI-адаптер (argparse → сервис → вывод)
│
├── rm/ # 🗑️ Домен: удаление
│ ├── engines/
│ │ └── rm.sh # Удаление файлов бэкапов
│ ├── services/
│ │ ├── __init__.py
│ │ └── rm_service.py # rm_ib(), rm_multiple()
│ └── adapters/
│   ├── cli/
│     └── rm_adapter.py # CLI-адаптер
│     ├── __init__.py
│
├── storage/ # 💾 Домен: мониторинг + управление списком ИБ
│ ├── engines/
│ │ ├── disk_usage.sh # Статистика диска (df)
│ │ ├── list_backups.sh # Список бэкапов (TSV)
│ │ ├── count_backups.sh # Подсчёт количества/размера бэкапов
│ │ ├── validate.sh # Валидация состояния хранилища
│ │ ├── list_ibs.sh # Получение списка ИБ из кластера 1С (rac)
│ │ └── ssl.sh # Управление SSL-сертификатами
│ ├── services/
│ │ ├── __init__.py
│ │ └── storage_service.py # get_usage(), get_ib_stats(), update_ib_list()
│ └── adapters/
│   ├── cli/
│     ├── __init__.py
│     └── storage_adapter.py # CLI-адаптер (storage, list-ibs, update-ib-list)
│
└── lic/ # 🪪 Домен: мониторинг и управление лицензиями 1С
│ ├── engines/
│ │ ├── license_list.sh # Список лицензий в табличном виде
│ │ ├── license_detail.sh # Чтение бинарных данных лицензии
│ │ ├── license_info.sh # Информация о состоянии лицензий
│ │ ├── monitor.sh # Мониторинг доступности лицензий
│ │ └── backup.sh # Создание архивных копий файлов лицензий
│ ├── services/
│ │ ├── __init__.p
│ │ └── lic_service.py # get_license_list(), backup_licenses()
│ ├── adapters/cli/
│ │ │── cli/
│ │   ├── __init__.py
│ │   └── lic_adapter.py # CLI-адаптер (lic list/backup/monitor)
│ └── config/
    └── lic.sh # Пути к файлам лицензий 1С
```

## 📚 Справочная система

Документация организована на двух уровнях для удобства разных сценариев использования:

| Уровень                      | Формат                                 | Когда использовать                                      | Доступ                                |
| ---------------------------- | -------------------------------------- | ------------------------------------------------------- | ------------------------------------- |
| **Консольная справка**       | `ib1c help`<br>`ib1c <команда> --help` | Быстрый поиск синтаксиса команды прямо в терминале      | Всегда доступна без интернета         |
| **Расширенная документация** | `.md` файлы в `docs/`                  | Изучение архитектуры, примеров, сценариев использования | На сервере: `/opt/1cv8/scripts/docs/` |

### Быстрый доступ к справке

```bash
# Список всех доступных команд с кратким описанием
ib1c help

# Подробная справка по конкретной команде
ib1c backup --help
ib1c rm --help
ib1c storage --help
ib1c lic --help
```

> 💡 **Правило:** Все команды имеют флаг `--help` / `-h`. Для получения списка команд используйте `ib1c help` или вызов без аргументов: `ib1c`.

## 🚀 Быстрый старт

```bash
# Создать бэкап тестовой ИБ в формате PostgreSQL Custom
ib1c backup --format dump --ib test_db

# Удалить конкретный бэкап тестовой ИБ (с подтверждением)
ib1c rm --ib test_db --timestamp 20260206_124957 --confirm

# Просмотреть статистику хранилища
ib1c storage

# Обновить список ИБ из кластера 1С
ib1c storage update-ib-list --confirm

# Просмотреть список лицензий 1С
ib1c lic list
```

> 💡 Подробная справка: `ib1c help` или `ib1c <команда> --help`

## ⚙️ Сервисы

| Сервис                  | Описание                                                                                                              | Команды                                                                                            |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| [`backup`](backup.md)   | Создание резервных копий ИБ в форматах `.dump` (PostgreSQL Custom) и `.sql.gz` (архивированный SQL)                   | `ib1c backup --format {dump,sql} --ib ИБ [ИБ ...] [--dry-run]`                                     |
| [`rm`](cmd.md#rm)       | Ручное удаление бэкапов по временной метке, дате или глобально (`--all`). Требует `--confirm` для реальных операций.  | `ib1c rm --ib ИБ [--timestamp МЕТКА \| --older-than ДАТА \| --all] [--dry-run] [--confirm]`        |
| [`storage`](storage.md) | Мониторинг хранилища: статистика диска, список бэкапов, валидация состояния, управление списком ИБ                    | `ib1c storage`<br>`ib1c storage list-ibs`<br>`ib1c storage update-ib-list [--dry-run] [--confirm]` |
| [`lic`](lic.md)         | Мониторинг и управление лицензиями 1С: список лицензий, резервное копирование файлов лицензий, мониторинг доступности | `ib1c lic list`<br>`ib1c lic backup [--dry-run]`<br>`ib1c lic monitor`                             |

## 🔐 Безопасность

- Все чувствительные данные (пароли, ключи) хранятся **только** в `config/global.sh`
- Операции изменения данных (`rm`, `backup`, `update-ib-list`, `lic backup`) требуют явного подтверждения (`--confirm`)
- Режим симуляции (`--dry-run`) доступен для всех деструктивных операций
- Удаление ИБ из `ib_list.conf` требует ручного подтверждения (защита от потери истории бэкапов)

## 📚 Дополнительная документация

- [backup.md](../backup/docs/backup.md) — детали работы с бэкапами
- [cmd.md](cmd.md) — полный справочник команд и флагов
- [storage.md](../storage/docs/storage.md) — спецификация домена мониторинга
- [lic.md](../lic/docs/lic.md) — спецификация домена лицензий
