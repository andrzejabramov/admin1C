# üîí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

## üß≠ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –≤–µ–±-–ø—É–±–ª–∏–∫–∞—Ü–∏–π 1–° —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **Let's Encrypt** (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ü–µ–Ω—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏) –∏ –∫–ª–∏–µ–Ω—Ç **Certbot**.

### –ì–¥–µ —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                    | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ                                     | –†–æ–ª—å                                                             |
| ---------------------------- | ------------------------------------------------ | ---------------------------------------------------------------- |
| **Let's Encrypt**            | –£–¥–∞–ª—ë–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (–°–®–ê/–ï–≤—Ä–æ–ø–∞)                 | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ü–µ–Ω—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤—ã–¥–∞—ë—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã)               |
| **Certbot**                  | `/usr/bin/certbot` (—Å–∏—Å—Ç–µ–º–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞)           | –ö–ª–∏–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è —Å Let's Encrypt –æ—Ç –∏–º–µ–Ω–∏ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ |
| **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã**              | `/etc/letsencrypt/live/bases.atotx.ru/`          | –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤                                |
| **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞** | `/etc/apache2/sites-enabled/`                    | –£–∫–∞–∑—ã–≤–∞–µ—Ç Apache, –≥–¥–µ –±—Ä–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –¥–æ–º–µ–Ω–∞               |
| **–í–∞—à —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**    | `/opt/1cv8/scripts/engines/ssl.sh` (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–π) | –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –≤—ã–∑–æ–≤–∞ certbot —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏                 |

> üí° **–í–∞–∂–Ω–æ:** Certbot ‚Äî —ç—Ç–æ **—Å–∏—Å—Ç–µ–º–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞**, –∞ –Ω–µ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–µ–∫—Ç–∞. –ï—ë –Ω–µ–ª—å–∑—è –∏ –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤ `/opt/1cv8/scripts/`, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –≥–ª—É–±–æ–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –û–° –∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–º.

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏—á–∏–Ω—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è                | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                                                                                                                                                                                                                 |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | Certbot –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —á–µ—Ä–µ–∑ `apt`:<br>- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ö—É–∫–∏ –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç Apache/Nginx)<br>- –°–æ–∑–¥–∞—ë—Ç `systemd`-—Ç–∞–π–º–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤)<br>- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –ø—É—Ç—è–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (`/var/www/html/.well-known/acme-challenge/`) |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**         | –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/etc/letsencrypt/` —Å –ø—Ä–∞–≤–∞–º–∏ `root:root` ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Linux. –ü–µ—Ä–µ–Ω–æ—Å –≤ `/opt/1cv8/scripts/` –Ω–∞—Ä—É—à–∏—Ç —ç—Ç—É –º–æ–¥–µ–ª—å.                                                                                                      |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**          | Certbot —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫:<br>- –ü–æ—Ä—Ç–∞–º 80/443 (–¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–º–µ–Ω–∞)<br>- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞<br>- –°–∏—Å—Ç–µ–º–Ω—ã–º –ø—É—Ç—è–º (`/etc`, `/var`)                                                                                                                                      |

---

## üîÅ –ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

### –®–∞–≥ 1: –ó–∞–ø—Ä–æ—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```bash
sudo certbot --apache -d bases.atotx.ru
```

# –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

Certbot –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞ bases.atotx.ru —á–µ—Ä–µ–∑ DNS
–°–æ–∑–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª-—Ç–æ–∫–µ–Ω –≤ /var/www/html/.well-known/acme-challenge/
Let's Encrypt –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ http://bases.atotx.ru/.well-known/acme-challenge/... –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –Ω–∞ –¥–æ–º–µ–Ω
–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á

# –®–∞–≥ 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Apache

Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
–°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SSL –≤ /etc/apache2/sites-enabled/
–î–æ–±–∞–≤–ª—è–µ—Ç –¥–∏—Ä–µ–∫—Ç–∏–≤—ã SSLEngine on, SSLCertificateFile, SSLCertificateKeyFile
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å HTTP (80) –Ω–∞ HTTPS (443)

# –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

```
sudo systemctl reload apache2
```

## –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É reload –∏ restart:

reload ‚Äî –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
restart ‚Äî –ø–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π)

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
sudo certbot certificates

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞ –ø–æ HTTPS
curl -I https://bases.atotx.ru

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Apache
sudo apache2ctl configtest
```

# üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

flowchart TD  
A[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è] --> B{–°—Ä–æ–∫ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ <30 –¥–Ω–µ–π?}  
B -->|–î–∞| C[–ó–∞–ø—Ä–æ—Å –Ω–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —É Let's Encrypt]  
B -->|–ù–µ—Ç| D[–ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è]  
C --> E[Let's Encrypt –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–º–µ–Ω]  
E -->|–£—Å–ø–µ—Ö| F[–í—ã–¥–∞—á–∞ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞]  
E -->|–û—à–∏–±–∫–∞| G[–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏]  
F --> H[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Apache]  
H --> I[–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Apache]  
I --> J[–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è]

# –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```
# –¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
sudo certbot renew --dry-run

# –†–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
sudo certbot renew

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Apache
sudo systemctl reload apache2
```

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç systemd-—Ç–∞–π–º–µ—Ä:

```
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–∞–π–º–µ—Ä–∞
sudo systemctl status certbot.timer

# –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
sudo systemctl list-timers | grep certbot
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤, –Ω–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ä–æ–∫ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ –º–µ–Ω–µ–µ 30 –¥–Ω–µ–π.

## ‚öôÔ∏è –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä                      | –ó–Ω–∞—á–µ–Ω–∏–µ                                |
| ----------------------------- | --------------------------------------- |
| **–î–æ–º–µ–Ω**                     | `bases.atotx.ru`                        |
| **–í–µ–±-—Å–µ—Ä–≤–µ—Ä**                | Apache 2.4.29 (Ubuntu)                  |
| **–ü–æ—Ä—Ç HTTPS**                | 443                                     |
| **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤** | `/etc/letsencrypt/live/bases.atotx.ru/` |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è**   | –ü–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º –≤ 02:30 (–≤—Ä—É—á–Ω—É—é)      |
| **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** | –ß–µ—Ä–µ–∑ `systemd`-—Ç–∞–π–º–µ—Ä (—Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤) |

# üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–µ–∫—Ç

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ë—Ä—Ç–∫–∞ engines/ssl.sh, –∫–æ—Ç–æ—Ä–∞—è:  
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (ssl.sh check)  
–ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (ssl.sh renew)  
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç Apache –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è  
–õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

# –ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞ engines/ssl.sh

```
#!/bin/bash
# engines/ssl.sh ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SSL

set -e

DOMAIN="bases.atotx.ru"
CERT_PATH="/etc/letsencrypt/live/$DOMAIN"

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] SSL: $1"; }

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
check_expiry() {
    if [ -f "$CERT_PATH/fullchain.pem" ]; then
        expiry=$(openssl x509 -enddate -noout -in "$CERT_PATH/fullchain.pem" | cut -d= -f2)
        log "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: $expiry"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å
        end_date=$(date -d "$(openssl x509 -enddate -noout -in "$CERT_PATH/fullchain.pem" | cut -d= -f2)" +%s)
        now=$(date +%s)
        days_left=$(( (end_date - now) / 86400 ))

        if [ $days_left -lt 30 ]; then
            log "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ $days_left –¥–Ω–µ–π!"
        else
            log "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –µ—â—ë $days_left –¥–Ω–µ–π"
        fi
    else
        log "‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        return 1
    fi
}

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–ª–∏–∑–æ–∫ –∫ –∏—Å—Ç–µ—á–µ–Ω–∏—é)
renew() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."

    # –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if sudo certbot renew --quiet --dry-run; then
        log "–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ"
    else
        log "–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ –æ—à–∏–±–∫–∞"
        return 1
    fi

    # –†–µ–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if sudo certbot renew --quiet; then
        log "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ–±–Ω–æ–≤–ª—ë–Ω"

        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Apache
        if sudo systemctl reload apache2; then
            log "‚úÖ Apache –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
        else
            log "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Apache"
            return 1
        fi
    else
        log "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        return 1
    fi
}

# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
status() {
    sudo certbot certificates
}

case "$1" in
    check) check_expiry ;;
    renew) renew ;;
    status) status ;;
    *) echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {check|renew|status}"; exit 1 ;;
esac
```

# –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ –∏–∑ –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞

```
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
python admin1c.py ssl check

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
python admin1c.py ssl renew

# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
python admin1c.py ssl status
```

# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

```
# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
sudo certbot certificates

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ
sudo openssl x509 -in /etc/letsencrypt/live/bases.atotx.ru/cert.pem -text -noout
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```
# –õ–æ–≥–∏ Certbot
sudo tail -f /var/log/letsencrypt/letsencrypt.log

# –õ–æ–≥–∏ Apache
sudo tail -f /var/log/apache2/error.log

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
sudo journalctl -u apache2 -f
```

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Apache
sudo apache2ctl configtest

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤
sudo ss -tulpn | grep ':443'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞
curl -I https://bases.atotx.ru
```

## ‚è±Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ cron

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º –≤ 02:30.

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è

```
# –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è usr1cv8 (–≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ 1–°)
sudo crontab -u usr1cv8 -l
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

```
30 2 * * 1 cd /opt/1cv8/scripts && /opt/1cv8/scripts/venv/bin/python admin1c.py ssl check >> /var/log/1c-admin/ssl-cron.log 2>&1
```

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞

| –≠–ª–µ–º–µ–Ω—Ç                | –ó–Ω–∞—á–µ–Ω–∏–µ                                    |
| ---------------------- | ------------------------------------------- |
| `30 2 * * 1`           | –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 02:30                  |
| `cd /opt/1cv8/scripts` | –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞        |
| `venv/bin/python`      | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ |
| `>> /var/log/...`      | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è          |

> üí° **–í–∞–∂–Ω–æ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `systemd`-—Ç–∞–π–º–µ—Ä `certbot.timer` (–Ω–µ —á–µ—Ä–µ–∑ cron). Cron –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

# üìã –¢–∞–±–ª–∏—Ü–∞ "–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏"

| –û—à–∏–±–∫–∞                                          | –†–µ—à–µ–Ω–∏–µ                                                                           |
| ----------------------------------------------- | --------------------------------------------------------------------------------- |
| `Failed to connect to host for DVSNI challenge` | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –ø–æ—Ä—Ç 80 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –≤ —Ñ–∞–µ—Ä–≤–æ–ª–µ                              |
| `No vhost exists with servername or alias`      | –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Apache –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ö–æ—Å—Ç –¥–ª—è `bases.atotx.ru`            |
| `Problem binding to port 80`                    | –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 80 ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--standalone` |
| `Certificate is not yet due for renewal`        | –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—â—ë –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è                             |

# üìã –¢–∞–±–ª–∏—Ü–∞ "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫"

| –û–ø–µ—Ä–∞—Ü–∏—è                     | –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å           | –ö–æ–º–∞–Ω–¥–∞                                             |
| ---------------------------- | ----------------------- | --------------------------------------------------- |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è      | –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ             | `python admin1c.py ssl check`                       |
| –¢–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ          | –ï–∂–µ–º–µ—Å—è—á–Ω–æ              | `sudo certbot renew --dry-run`                      |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Apache | –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è | `sudo apache2ctl configtest`                        |
| –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤               | –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö           | `sudo tail -f /var/log/letsencrypt/letsencrypt.log` |
