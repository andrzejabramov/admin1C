#!/usr/bin/env python3
"""
1C Server Admin Toolkit ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º 1–°
–ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: Python (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) + Bash (–Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
"""

import argparse
import subprocess
import sys
from pathlib import Path
from lib.config import load_version, load_ib_list

BASE_DIR = Path(__file__).resolve().parent
ENGINES_DIR = BASE_DIR / "engines"

def run_engine(engine_name: str, args: list = None) -> int:
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç bash-–¥–≤–∏–∂–æ–∫ –∏–∑ –ø–∞–ø–∫–∏ engines/
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ —Å–∫—Ä–∏–ø—Ç–∞
    """
    engine_path = ENGINES_DIR / engine_name
    if not engine_path.exists():
        print(f"‚ùå –î–≤–∏–∂–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω: {engine_path}", file=sys.stderr)
        return 1
    
    cmd = [str(engine_path)]
    if args:
        cmd.extend(args)
    
    try:
        result = subprocess.run(cmd, check=False)
        return result.returncode
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {e}", file=sys.stderr)
        return 1

def cmd_backup(args):
    """–ö–æ–º–∞–Ω–¥–∞: –±—ç–∫–∞–ø –ò–ë"""
    format_map = {"dump": "backup_dump.sh", "sql": "backup_sql.sh"}
    engine = format_map.get(args.format)
    
    if not engine:
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {args.format}", file=sys.stderr)
        return 1
    
    if args.all:
        ib_list = load_ib_list()
        if not ib_list:
            print("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ò–ë –ø—É—Å—Ç (ib_list.conf)", file=sys.stderr)
            return 1
        
        print(f"üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ –¥–ª—è {len(ib_list)} –ò–ë –≤ —Ñ–æ—Ä–º–∞—Ç–µ {args.format}...")
        for ib in ib_list:
            print(f"  ‚Üí {ib}")
            run_engine(engine, ["--ib", ib])
    elif args.ib:
        print(f"üì¶ –ë—ç–∫–∞–ø –ò–ë '{args.ib}' –≤ —Ñ–æ—Ä–º–∞—Ç–µ {args.format}...")
        run_engine(engine, ["--ib", args.ib.strip()])
    else:
        print("‚ùå –£–∫–∞–∂–∏—Ç–µ --all –∏–ª–∏ --ib <–∏–º—è_–ò–ë>", file=sys.stderr)
        return 1
    
    return 0

def cmd_sessions(args):
    """–ö–æ–º–∞–Ω–¥–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏"""
    print("üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö —Å–µ—Å—Å–∏–π...")
    return run_engine("cleanup.sh")

def cmd_cloud(args):
    """–ö–æ–º–∞–Ω–¥–∞: —Ä–∞–±–æ—Ç–∞ —Å –æ–±–ª–∞–∫–æ–º"""
    print("‚òÅÔ∏è –í—ã–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞–∫–æ...")
    return run_engine("cloud_upload.sh")

def cmd_ssl(args):
    """–ö–æ–º–∞–Ω–¥–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏"""
    actions = {
        "check": ["check"],
        "status": ["status"],
        "renew": ["renew"] + (["--dry-run"] if args.dry_run else [])
    }
    
    action = args.action
    if action not in actions:
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}", file=sys.stderr)
        return 1
    
    print(f"üîí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL –¥–ª—è –¥–æ–º–µ–Ω–∞: {load_version().replace("VERSION=", "").strip() or "bases.atotx.ru"}")
    print(f"   –î–µ–π—Å—Ç–≤–∏–µ: {action}")
    
    return run_engine("ssl.sh", actions[action])

def main():
    parser = argparse.ArgumentParser(
        description="1C Server Admin Toolkit",
        formatter_class=argparse.RawTextHelpFormatter
    )
    parser.add_argument(
        "--version", action="version", version=f"%(prog)s {load_version()}"
    )
    
    subparsers = parser.add_subparsers(dest="command", required=True, help="–ö–æ–º–∞–Ω–¥—ã")
    
    # backup
    backup_parser = subparsers.add_parser("backup", help="–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –ò–ë")
    backup_parser.add_argument(
        "--format", choices=["dump", "sql"], required=True, help="–§–æ—Ä–º–∞—Ç –±—ç–∫–∞–ø–∞: dump (pg_dump) –∏–ª–∏ sql (pg_dump | gzip)"
    )
    group = backup_parser.add_mutually_exclusive_group(required=True)
    group.add_argument("--all", action="store_true", help="–í—Å–µ –ò–ë –∏–∑ ib_list.conf")
    group.add_argument("--ib", type=str, help="–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ò–ë")
    backup_parser.set_defaults(func=cmd_backup)
    
    # sessions
    sessions_parser = subparsers.add_parser("sessions", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏")
    sessions_parser.add_argument("action", choices=["cleanup"], help="–î–µ–π—Å—Ç–≤–∏–µ")
    sessions_parser.set_defaults(func=cmd_sessions)
    
    # cloud
    cloud_parser = subparsers.add_parser("cloud", help="–†–∞–±–æ—Ç–∞ —Å –æ–±–ª–∞—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º")
    cloud_parser.add_argument("action", choices=["upload"], help="–î–µ–π—Å—Ç–≤–∏–µ")
    cloud_parser.set_defaults(func=cmd_cloud)
    
    # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã

    # ssl
    ssl_parser = subparsers.add_parser("ssl", help="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏")
    ssl_parser.add_argument("action", choices=["check", "status", "renew"], help="–î–µ–π—Å—Ç–≤–∏–µ")
    ssl_parser.add_argument("--dry-run", action="store_true", help="–¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π")
    ssl_parser.set_defaults(func=cmd_ssl)
    args = parser.parse_args()
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
    sys.exit(args.func(args))

if __name__ == "__main__":
    main()

def cmd_ssl(args):
    """–ö–æ–º–∞–Ω–¥–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏"""
    actions = {
        "check": ["check"],
        "status": ["status"],
        "renew": ["renew"] + (["--dry-run"] if args.dry_run else [])
    }
    
    action = args.action
    if action not in actions:
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: {action}", file=sys.stderr)
        return 1
    
    print(f"üîí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL –¥–ª—è –¥–æ–º–µ–Ω–∞: {load_version().replace('VERSION=', '').strip() or 'bases.atotx.ru'}")
    print(f"   –î–µ–π—Å—Ç–≤–∏–µ: {action}")
    
    return run_engine("ssl.sh", actions[action])

